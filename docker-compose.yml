# QuakeLiveInterface - Full Stack with Custom MinQLX Build
#
# Usage:
#   docker-compose build   # Build the custom image (first time only)
#   docker-compose up -d   # Start the stack
#   Connect to localhost:27960 in Quake Live

services:
  redis:
    image: redis:7-alpine
    container_name: ql-redis
    ports:
      - "127.0.0.1:6379:6379"
    # Optimized Redis settings for game loop reliability
    command: >
      redis-server
      --tcp-keepalive 60
      --timeout 0
      --tcp-backlog 511
      --maxclients 100
      --save ""
      --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
    restart: unless-stopped

  quake-server:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: quakelive-agent:latest
    container_name: ql-server-0
    ports:
      - "27961:27960/udp"
      - "27961:27960/tcp"
    volumes:
      - ./minqlx-plugin:/qlds/minqlx_plugins:ro
    environment:
      - QLX_REDISADDRESS=redis
      - QLX_OWNER=76561197984141695
      - QLX_AGENTSTEAMID=76561197984141695
      - QLX_AGENTBOTNAME=anarki
      - MAP=campgrounds
      - GAMETYPE=duel
      # ===== ISOLATION TESTING FLAGS =====
      # Set to "1" to enable, "0" to disable
      - QL_AGENT_ENABLE=1
      # Re-enabled after implementing background publisher memory leak fix
      - QL_AGENT_ENABLE_STATE_LOOP=1
      - QL_AGENT_ENABLE_SET_USERCMD=1
      - QL_AGENT_ENABLE_EVENTS=1
      - QL_AGENT_ENABLE_ADMIN=1
      - QL_AGENT_ENABLE_COMMANDS=1
      # Environment ID for namespacing (must match training env_id)
      - QLX_ENV_ID=0
      # Spawn loadout for CA-style curriculum
      - QL_SPAWN_LOADOUT=1
    healthcheck:
      test: ["CMD", "/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          # Increased from 512M due to memory leak causing OOM kills every ~9 minutes
          # TODO: Find and fix memory leak in minqlx/ql_agent_plugin
          memory: 2G
    depends_on:
      redis:
        condition: service_healthy
    # DEBUG: Changed to on-failure so exit(0) won't auto-restart
    # This helps debug why the server is exiting cleanly
    restart: "on-failure:3"

networks:
  default:
    name: quakelive-net
