# QuakeLiveInterface - Full Stack
#
# Usage:
#   docker-compose up -d
#   poetry run python visualizer.py
#   poetry run python agents/random_agent.py
#   Connect to localhost:27960 in Quake Live

services:
  redis:
    image: redis:7-alpine
    container_name: ql-redis
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  quake-server:
    image: jamesla/quakelive:latest
    container_name: ql-server
    ports:
      - "27960:27960/udp"
      - "27960:27960/tcp"
    volumes:
      - ./minqlx-plugin/ql_agent_plugin.py:/qlds/minqlx-plugins/ql_agent_plugin.py:ro
    environment:
      - ACCESS=76561197984141695|admin
      - QLX_REDISADDRESS=redis
      - QLX_PLUGINS=plugin_manager, essentials, motd, permission, ban, silence, clan, names, log, workshop, ql_agent_plugin
      - QLX_OWNER=76561197984141695
      - QLX_AGENTSTEAMID=76561197984141695
      - SERVER_CFG=set sv_hostname AgentTraining; set g_gametype 1; set sv_maxclients 2; set fraglimit 0; set timelimit 0; set g_inactivity 0; set qlx_redisAddress redis; set qlx_owner 76561197984141695; set qlx_agentSteamId 76561197984141695; set qlx_plugins "plugin_manager, essentials, ql_agent_plugin"
      - MAP_POOL=toxicity|duel
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

networks:
  default:
    name: quakelive-net
