# QuakeLiveInterface - Full Stack with Custom MinQLX Build
#
# Usage:
#   docker-compose build   # Build the custom image (first time only)
#   docker-compose up -d   # Start the stack
#   Connect to localhost:27960 in Quake Live

services:
  redis:
    image: redis:7-alpine
    container_name: ql-redis
    ports:
      - "127.0.0.1:6379:6379"
    # Optimized Redis settings for game loop reliability
    command: >
      redis-server
      --tcp-keepalive 60
      --timeout 0
      --tcp-backlog 511
      --maxclients 100
      --save ""
      --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
    restart: unless-stopped

  quake-server:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: quakelive-agent:latest
    container_name: ql-server
    ports:
      - "27960:27960/udp"
      - "27960:27960/tcp"
    volumes:
      - ./minqlx-plugin:/qlds/minqlx_plugins:ro
    environment:
      - QLX_REDISADDRESS=redis
      - QLX_OWNER=76561197984141695
      - QLX_AGENTSTEAMID=76561197984141695
      - QLX_AGENTBOTNAME=anarki
      - MAP=campgrounds
      - GAMETYPE=duel
      # ===== ISOLATION TESTING FLAGS =====
      # Set to "1" to enable, "0" to disable
      - QL_AGENT_ENABLE=1
      - QL_AGENT_ENABLE_STATE_LOOP=1
      - QL_AGENT_ENABLE_SET_USERCMD=1
      - QL_AGENT_ENABLE_EVENTS=1
      - QL_AGENT_ENABLE_ADMIN=1
      - QL_AGENT_ENABLE_COMMANDS=1
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

networks:
  default:
    name: quakelive-net
