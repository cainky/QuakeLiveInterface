# QuakeLiveInterface - Multi-Server Setup for Parallel Training
#
# Usage:
#   docker-compose -f docker-compose.multi.yml up -d   # Start 4 servers
#
# Each server uses a unique QLX_ENV_ID for Redis namespacing:
#   Server 0: ql:0:agent:*, port 27960
#   Server 1: ql:1:agent:*, port 27961
#   Server 2: ql:2:agent:*, port 27962
#   Server 3: ql:3:agent:*, port 27963

services:
  redis:
    image: redis:7-alpine
    container_name: ql-redis
    ports:
      - "127.0.0.1:6379:6379"
    # Optimized Redis settings for game loop reliability
    # - tcp-keepalive: Detect dead connections
    # - timeout 0: Never timeout idle connections
    # - save "": Disable RDB persistence (in-memory only)
    # - appendonly no: Disable AOF for maximum performance
    command: >
      redis-server
      --tcp-keepalive 60
      --timeout 0
      --tcp-backlog 511
      --maxclients 200
      --save ""
      --appendonly no
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
    restart: unless-stopped

  quake-server-0:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: quakelive-agent:latest
    container_name: ql-server-0
    ports:
      - "27960:27960/udp"
      - "27960:27960/tcp"
    volumes:
      - ./minqlx-plugin:/qlds/minqlx_plugins:ro
    environment:
      - QLX_ENV_ID=0
      - QLX_REDISADDRESS=redis
      - QLX_OWNER=76561197984141695
      - QLX_AGENTSTEAMID=76561197984141695
      - QLX_AGENTBOTNAME=anarki
      - MAP=campgrounds
      - GAMETYPE=duel
      - QL_AGENT_ENABLE=1
      - QL_AGENT_ENABLE_STATE_LOOP=1
      - QL_AGENT_ENABLE_SET_USERCMD=1
      - QL_AGENT_ENABLE_EVENTS=1
      - QL_AGENT_ENABLE_ADMIN=1
      - QL_AGENT_ENABLE_COMMANDS=1
    healthcheck:
      test: ["/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  quake-server-1:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: quakelive-agent:latest
    container_name: ql-server-1
    ports:
      - "27961:27960/udp"
      - "27961:27960/tcp"
    volumes:
      - ./minqlx-plugin:/qlds/minqlx_plugins:ro
    environment:
      - QLX_ENV_ID=1
      - QLX_REDISADDRESS=redis
      - QLX_OWNER=76561197984141695
      - QLX_AGENTSTEAMID=76561197984141695
      - QLX_AGENTBOTNAME=anarki
      - MAP=campgrounds
      - GAMETYPE=duel
      - QL_AGENT_ENABLE=1
      - QL_AGENT_ENABLE_STATE_LOOP=1
      - QL_AGENT_ENABLE_SET_USERCMD=1
      - QL_AGENT_ENABLE_EVENTS=1
      - QL_AGENT_ENABLE_ADMIN=1
      - QL_AGENT_ENABLE_COMMANDS=1
    healthcheck:
      test: ["/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  quake-server-2:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: quakelive-agent:latest
    container_name: ql-server-2
    ports:
      - "27962:27960/udp"
      - "27962:27960/tcp"
    volumes:
      - ./minqlx-plugin:/qlds/minqlx_plugins:ro
    environment:
      - QLX_ENV_ID=2
      - QLX_REDISADDRESS=redis
      - QLX_OWNER=76561197984141695
      - QLX_AGENTSTEAMID=76561197984141695
      - QLX_AGENTBOTNAME=anarki
      - MAP=campgrounds
      - GAMETYPE=duel
      - QL_AGENT_ENABLE=1
      - QL_AGENT_ENABLE_STATE_LOOP=1
      - QL_AGENT_ENABLE_SET_USERCMD=1
      - QL_AGENT_ENABLE_EVENTS=1
      - QL_AGENT_ENABLE_ADMIN=1
      - QL_AGENT_ENABLE_COMMANDS=1
    healthcheck:
      test: ["/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  quake-server-3:
    build:
      context: .
      dockerfile: Dockerfile.server
    image: quakelive-agent:latest
    container_name: ql-server-3
    ports:
      - "27963:27960/udp"
      - "27963:27960/tcp"
    volumes:
      - ./minqlx-plugin:/qlds/minqlx_plugins:ro
    environment:
      - QLX_ENV_ID=3
      - QLX_REDISADDRESS=redis
      - QLX_OWNER=76561197984141695
      - QLX_AGENTSTEAMID=76561197984141695
      - QLX_AGENTBOTNAME=anarki
      - MAP=campgrounds
      - GAMETYPE=duel
      - QL_AGENT_ENABLE=1
      - QL_AGENT_ENABLE_STATE_LOOP=1
      - QL_AGENT_ENABLE_SET_USERCMD=1
      - QL_AGENT_ENABLE_EVENTS=1
      - QL_AGENT_ENABLE_ADMIN=1
      - QL_AGENT_ENABLE_COMMANDS=1
    healthcheck:
      test: ["/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

networks:
  default:
    name: quakelive-net
